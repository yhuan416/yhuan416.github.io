# WireGuard

[WireGuard官网: https://www.wireguard.com/](https://www.wireguard.com/)  
[WireGuard官网下载页面](https://www.wireguard.com/install/)  
[Wireguard 白皮书带读](https://www.zhihu.com/column/c_1498091755665240064)

## 安装wireguard

较新版本的linux发行版基本都可以直接安装, 以ubuntu举例

``` bash
sudo apt install wireguard
```

## Wireguard手册查看

安装完成后可以直接通过man查看相关使用文档

```
man wg
man wg-quick
```

## 生成密钥对

生成私钥并保存到文件中
``` bash
wg genkey > privatekey
```

获取私钥对应的公钥
``` bash
wg pubkey < privatekey
```

也可以一步到位
``` bash
wg genkey | tee privatekey | wg pubkey > publickey
```

## 配置文件

```
[Interface]
PrivateKey = ${之前在本机上生成的私钥}
Address = 10.0.0.1/24
PostUp = iptables -A FORWARD -i %i -o %i -j ACCEPT;
PostDown = iptables -D FORWARD -i %i -o %i -j ACCEPT;
ListenPort = 50416

[Peer]
PublicKey = ${对端机器的公钥}
AllowedIPs = 10.0.0.2/32
```

### Interface

> - PrivateKey  

当前接口的私钥  
``` txt
PrivateKey -- a base64 private key generated by wg genkey. Required.
```

> - Address

配置接口的IP地址
``` txt
a comma-separated list of IP (v4 or v6) addresses (optionally with CIDR masks) to be  assigned  to  the interface. May be specified multiple times.
```

> - ListenPort

当前接口监听的端口
``` txt
a 16-bit port for listening. Optional; if not specified, chosen randomly.
```

> - PreUp,  PostUp,  PreDown,  PostDown

接口启停事件脚本
``` txt
script  snippets  which  will be executed by bash(1) before/after setting up/tearing down the interface, most commonly used to configure custom DNS options or firewall rules.  The  special string `%i' is expanded to INTERFACE. Each one may be specified multiple times, in which case the commands are executed in order.
```

### Peer

> - PublicKey

对端的公钥
``` txt
a base64 public key calculated by wg pubkey from a private key, and usually transmitted out of band to the author of the configuration file. Required.
```

> - PresharedKey

对端预分享key
``` txt
a base64 preshared key generated by wg genpsk. Optional, and may be omitted. This option  adds  an additional  layer of symmetric-key cryptography to be mixed into the already existing public-key cryptography, for post-quantum resistance.
```

> - AllowedIPs

允许的IP
``` txt
a comma-separated list of IP (v4 or v6) addresses with CIDR masks from which  incoming  traffic  for this peer is allowed and to which outgoing traffic for this peer is directed. The catch-all 0.0.0.0/0 may be specified for matching all IPv4 addresses, and ::/0 may be specified for matching all IPv6 addresses. May be specified multiple times.
```

> - Endpoint

对端的IP, 端口信息
``` txt
an endpoint IP or hostname, followed by a colon, and then a port number. This endpoint will be updated automatically to the most recent source IP address and port of correctly authenticated packets from the peer.  Optional.
```

> - PersistentKeepalive

保活时间间隔
``` txt
a  seconds interval, between 1 and 65535 inclusive, of how often to send an authenticated empty packet to the peer for the purpose of keeping a stateful firewall or NAT mapping valid persistently. For ex-ample,  if the interface very rarely sends traffic, but it might at anytime receive traffic from a peer, and it is behind NAT, the interface might benefit from having a persistent keepalive interval of 25 seconds. If set to 0  or "off", this option is disabled. By default or when unspecified, this option is off. Most users will not need this. Optional.
```

## 通过systemctl管理服务 

```
# 设置开机自启
systemctl enable wg-quick@wg0

# 取消开机自启
systemctl disable wg-quick@wg0
```
